name: Build Detectron2 Wheels

on:
  workflow_dispatch:

jobs:
  build-linux-cuda:
    runs-on: ubuntu-latest
    steps:
      - uses: jlumbroso/free-disk-space@main
        with:
          android: true
          dotnet: true
          haskell: true
          large-packages: false
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Build wheel
        run: |
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cu128
          pip install setuptools wheel ninja
          git clone https://github.com/facebookresearch/detectron2.git  /tmp/d2
          cd /tmp/d2 && git checkout a1ce2f9 && pip wheel . -w /tmp/wheels --no-build-isolation
          cd /tmp/wheels && for f in detectron2-*.whl; do mv "$f" "$(echo $f | sed 's/detectron2-\([^-]*\)-/detectron2-\1+cu128-/')"; done
      
      - uses: actions/upload-artifact@v4
        with:
          name: linux-cuda-wheel
          path: /tmp/wheels/detectron2*.whl

  build-linux-rocm:
    runs-on: ubuntu-latest
    steps:
      - uses: jlumbroso/free-disk-space@main
        with:
          android: true
          dotnet: true
          haskell: true
          large-packages: false
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Build wheel
        run: |
          pip install torch torchvision --index-url https://download.pytorch.org/whl/rocm6.4
          pip install setuptools wheel ninja
          git clone https://github.com/facebookresearch/detectron2.git /tmp/d2
          cd /tmp/d2 && git checkout a1ce2f9 && pip wheel . -w /tmp/wheels --no-build-isolation
          cd /tmp/wheels && for f in detectron2-*.whl; do mv "$f" "$(echo $f | sed 's/detectron2-\([^-]*\)-/detectron2-\1+rocm64-/')"; done
      
      - uses: actions/upload-artifact@v4
        with:
          name: linux-rocm-wheel
          path: /tmp/wheels/detectron2*.whl

  build-windows:
    runs-on: windows-2022
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      
      - name: Build wheel
        run: |
          pip install torch==2.7.1 torchvision==0.22.1 --index-url https://download.pytorch.org/whl/cu128
          pip install setuptools wheel ninja
          $env:DISTUTILS_USE_SDK = "1"
          pip wheel git+https://github.com/facebookresearch/detectron2.git@a1ce2f9 --no-build-isolation --no-deps -w C:\wheels
          cd C:\wheels
          Get-ChildItem detectron2-*.whl | Rename-Item -NewName { $_.Name -replace 'detectron2-([^-]+)-', 'detectron2-$1+cu128-' }
        shell: pwsh
      
      - uses: actions/upload-artifact@v4
        with:
          name: windows-wheel
          path: C:\wheels\detectron2*.whl

  release:
    needs: [build-linux-cuda, build-linux-rocm, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: wheels
          merge-multiple: true
      
      - name: List wheels
        run: ls -la wheels/
      
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Detectron2 Wheels (Python 3.12)
          files: wheels/*.whl
